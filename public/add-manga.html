<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Ajouter une série — Admin</title>
  <link rel="stylesheet" href="/styles/base.css"/>
</head>
<body>
  <div class="header">
    <div class="bar">
      <a class="brand" href="/">K</a>
      <span class="badge">Admin</span>
      <div class="right"><a class="btn" href="/admin.html">Panneau</a></div>
    </div>
  </div>

  <div class="container grid" style="grid-template-columns:2fr 1fr; gap:18px">
    <form id="form" class="card">
      <h2 style="margin:0 0 12px 0">Ajouter une série</h2>

      <label class="label">Titre</label>
      <input id="title" class="in" placeholder="Titre" required />

      <label class="label">Tags (séparés par virgules)</label>
      <input id="tags" class="in" placeholder="action, fantasy" />

      <label class="label">Statut</label>
      <select id="status" class="in">
        <option>En cours</option>
        <option>Terminé</option>
        <option>Pause</option>
      </select>

      <label class="label">Description</label>
      <textarea id="desc" class="in" rows="8" placeholder="Synopsis..."></textarea>

      <label class="label">Cover</label>
      <input id="cover" type="file" accept="image/*" class="in" />

      <div style="margin-top:14px; display:flex; gap:10px">
        <button class="btn acc" type="submit">Enregistrer</button>
        <a class="btn" href="/admin.html">Annuler</a>
      </div>
    </form>

    <aside class="card" id="previewCard" style="min-height:260px; display:grid; place-items:center">
      <div id="pv" class="label">Aucun fichier</div>
    </aside>
  </div>

  <footer>© 2025 — Admin Kyy’s Letters</footer>

  <script src="/js/storage.js"></script>
  <script>
    const { allSeries, saveSeries, putImage } = KyyStore;

    const titleEl = document.getElementById("title");
    const tagsEl  = document.getElementById("tags");
    const statusEl= document.getElementById("status");
    const descEl  = document.getElementById("desc");
    const coverEl = document.getElementById("cover");
    const pvEl    = document.getElementById("pv");

    // Aperçu cover
    coverEl.addEventListener("change", () => {
      pvEl.innerHTML = "";
      const f = coverEl.files?.[0];
      if (!f) { pvEl.textContent = "Aucun fichier"; return; }
      const url = URL.createObjectURL(f);
      const img = new Image();
      img.src = url;
      img.style.maxWidth = "100%";
      img.style.borderRadius = "10px";
      pvEl.appendChild(img);
    });

    function slugify(str){
      return str.toLowerCase()
        .normalize('NFD').replace(/[\u0300-\u036f]/g,'')
        .replace(/[^a-z0-9]+/g,'-').replace(/(^-|-$)/g,'');
    }

    document.getElementById("form").addEventListener("submit", async (e) => {
      e.preventDefault();

      const title = titleEl.value.trim();
      if (!title) { alert("Titre requis."); return; }

      const list = allSeries();
      const id   = crypto.randomUUID();
      const slug = slugify(title);
      const tags = tagsEl.value.split(",").map(t=>t.trim()).filter(Boolean);

      const serie = {
        id, title, slug, tags,
        description: descEl.value || "",
        status: statusEl.value || "En cours",
        coverKey: null,
        views: 0, hot: false,
        chapters: []
      };

      // cover -> IndexedDB
      const f = coverEl.files?.[0];
      if (f) {
        const key = `cover:${id}`;
        await putImage(key, f);
        serie.coverKey = key;
      }

      list.push(serie);
      saveSeries(list);

      alert("Série ajoutée.");
      location.href = "/admin.html";
    });
  </script>
</body>
</html>
