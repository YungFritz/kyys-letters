<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Ajouter une série — Admin</title>
  <link rel="stylesheet" href="/styles/base.css" />
</head>
<body>
  <div class="header">
    <div class="bar">
      <div class="brand">K</div>
      <div class="badge">Admin</div>
      <div class="right">
        <a class="btn" href="/admin.html">Panneau</a>
      </div>
    </div>
  </div>

  <main class="container">
    <div class="grid" style="grid-template-columns: 1.4fr .9fr; gap:18px">
      <div class="card">
        <h2 style="margin:0 0 10px">Ajouter une série</h2>
        <form id="mangaForm" class="grid" style="grid-template-columns:1fr">
          <label class="label">Titre</label>
          <input id="title" class="in" placeholder="Titre" required />

          <label class="label">Tags (séparés par virgules)</label>
          <input id="tags" class="in" placeholder="action, fantasy" />

          <label class="label">Statut</label>
          <select id="status" class="in">
            <option value="En cours">En cours</option>
            <option value="Terminé">Terminé</option>
            <option value="Pause">Pause</option>
          </select>

          <label class="label">Description</label>
          <textarea id="desc" class="in" rows="6" placeholder="Synopsis..."></textarea>

          <label class="label">Cover</label>
          <input id="cover" type="file" accept="image/*" />

          <div style="margin-top:12px; display:flex; gap:10px">
            <button class="btn acc" type="submit">Enregistrer</button>
            <a class="btn" href="/admin.html">Annuler</a>
          </div>
        </form>
      </div>

      <aside class="card">
        <h3 style="margin:0 0 8px">Aperçu cover</h3>
        <div id="preview" class="cover" style="height:360px; display:grid; place-items:center; color:#aaa;">Aucun fichier</div>
      </aside>
    </div>
  </main>

  <footer>© 2025 — Admin Kyy’s Letters</footer>

  <script src="/js/db.js"></script>
  <script src="/js/storage.js"></script>
  <script>
    const { uid, allSeries, saveSeries, storeCover } = KyyStore;

    const form = document.getElementById('mangaForm');
    const coverInput = document.getElementById('cover');
    const pv = document.getElementById('preview');

    coverInput.addEventListener('change', () => {
      const f = coverInput.files && coverInput.files[0];
      if (!f) { pv.textContent = 'Aucun fichier'; return; }
      const url = URL.createObjectURL(f);
      pv.innerHTML = `<img src="${url}" style="width:100%;height:100%;object-fit:cover" />`;
    });

    form.onsubmit = async (e) => {
      e.preventDefault();

      const title = document.getElementById('title').value.trim();
      const tags  = document.getElementById('tags').value.split(',').map(s=>s.trim()).filter(Boolean);
      const status= document.getElementById('status').value.trim();
      const desc  = document.getElementById('desc').value.trim();

      const slug = title
        .toLowerCase()
        .replace(/[^a-z0-9]+/g,'-')
        .replace(/(^-|-$)/g,'');

      let coverRef = null;
      const file = coverInput.files && coverInput.files[0];
      if (file) coverRef = await storeCover(file);

      const s = allSeries();
      s.push({
        id: uid('serie'),
        title, slug, tags, status,
        description: desc,
        coverRef,
        views: 0,
        hot: false,
      });
      saveSeries(s);

      location.href = '/admin.html';
    };
  </script>
</body>
</html>
