<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Admin — Ajouter une série</title>
  <link rel="stylesheet" href="/styles/base.css"/>
  <style>
    .wrap{max-width:980px;margin:22px auto;padding:0 16px}
    .f{display:grid;gap:10px}
    .in{height:38px;border:1px solid var(--border);border-radius:10px;background:#101112;color:#eaecef;padding:0 12px}
    textarea.in{height:120px;padding:10px}
    .row{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
    .preview{width:120px;height:160px;border:1px solid var(--border);border-radius:12px;overflow:hidden;display:grid;place-items:center;background:#0f1012;color:var(--muted)}
    .preview img{width:100%;height:100%;object-fit:cover}
  </style>
</head>
<body>
  <!-- Header -->
  <div class="header">
    <div class="bar">
      <div class="brand">K</div>
      <div class="badge">Admin</div>
      <div class="right">
        <a class="btn" href="/">Accueil</a>
        <a class="btn" href="/admin.html">Panneau</a>
      </div>
    </div>
  </div>

  <div class="wrap">
    <div class="card">
      <h2 style="margin:0 0 10px 0">Ajouter une série</h2>
      <form id="form" class="f">
        <input id="title" class="in" placeholder="Titre" required />
        <input id="tags" class="in" placeholder="Tags (séparés par des virgules)" />
        <textarea id="desc" class="in" placeholder="Description"></textarea>

        <div class="row">
          <div class="preview" id="pv"><span>COVER</span></div>
          <input id="cover" class="in" type="file" accept="image/*" style="flex:1"/>
          <button class="btn acc" type="submit">Enregistrer</button>
          <a class="btn" href="/admin.html">Annuler</a>
        </div>
      </form>
      <div id="msg" class="label" style="margin-top:8px"></div>
    </div>
  </div>

  <footer>© 2025 — Admin Kyy’s Letters</footer>

  <script src="/js/storage.js"></script>
  <script>
    const { allSeries, saveSeries, slugify } = KyyStore;

    // Aperçu cover
    const pv = document.getElementById('pv');
    document.getElementById('cover').addEventListener('change', async (e)=>{
      const f = e.target.files?.[0];
      if(!f){ pv.innerHTML='<span>COVER</span>'; return; }
      const b64 = await toBase64(f);
      pv.innerHTML = '<img />'; pv.firstChild.src = b64;
    });

    document.getElementById('form').addEventListener('submit', async (e)=>{
      e.preventDefault();
      const title = document.getElementById('title').value.trim();
      const tags = document.getElementById('tags').value.split(',').map(s=>s.trim()).filter(Boolean);
      const desc = document.getElementById('desc').value.trim();
      const f = document.getElementById('cover').files?.[0];
      const cover = f ? await toBase64(f) : '';

      const list = allSeries();
      const data = {
        id: crypto.randomUUID(),
        title,
        slug: slugify(title),
        tags,
        description: desc,
        status: 'en-cours',
        cover,
        chapters: [],
        views: 0,
        hot: false,
        createdAt: Date.now()
      };
      // doublon sur slug
      if(list.some(s=>s.slug===data.slug)){
        return msg("Une série avec ce titre existe déjà.");
      }
      list.push(data);
      saveSeries(list);
      msg("Série enregistrée ✅");
      // location.href = "/admin.html";
    });

    function msg(t){ document.getElementById('msg').textContent=t; }
    function toBase64(file){
      return new Promise((res,rej)=>{
        const r=new FileReader();
        r.onload=()=>res(String(r.result)); r.onerror=rej; r.readAsDataURL(file);
      });
    }
  </script>
</body>
</html>
