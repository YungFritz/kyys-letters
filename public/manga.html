<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Manga — Kyy’s Letters</title>
  <link rel="stylesheet" href="/styles/base.css"/>
  <style>
    body{background:#0f1011;color:#e9ebee}
    .wrap{max-width:1100px;margin:18px auto;padding:0 12px}
    .top{display:flex;align-items:start;gap:18px}
    .cover{width:260px;min-height:360px;background:#0e0f10;border:1px solid var(--border);border-radius:12px;display:grid;place-items:center;overflow:hidden}
    .cover img{width:100%;display:block}
    .title{font-weight:900;font-size:26px;margin:0 0 8px 0}
    .muted{color:var(--muted)}
    .chips{display:flex;flex-wrap:wrap;gap:8px;margin:10px 0}
    .chip{padding:4px 8px;border:1px solid var(--border);border-radius:999px;background:#101112}
    .grid{display:grid;grid-template-columns:1fr;gap:12px;margin-top:16px}
    .item{display:flex;align-items:center;gap:12px;border:1px solid var(--border);border-radius:10px;padding:10px;background:#121315}
    .btn{display:inline-grid;place-items:center;height:36px;padding:0 12px;border:1px solid var(--border);border-radius:10px;background:#101112;color:#e9ebee;text-decoration:none}
    .nav{display:flex;gap:8px;flex-wrap:wrap;margin-bottom:10px}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="nav">
      <a class="btn" href="/">Accueil</a>
      <!-- Le lien Admin est affiché par défaut puis masqué si l'utilisateur n'est pas connecté -->
      <a class="btn" href="/admin.html" id="adminBtn">Admin</a>
    </div>

    <div id="view"></div>
  </div>

  <!-- Chargement de la bibliothèque de stockage unifiée -->
  <!-- Utilise le script de stockage situé dans /js afin d'être compatible avec la structure du site -->
  <script src="/js/storage.js"></script>
  <script>
    (async () => {
      // S'assure que l'API de stockage est chargée
      const store = window.KyyStore || {};
      // Fonction utilitaire pour savoir si un utilisateur est connecté
      const isLogged = store.isLogged ? store.isLogged() : !!localStorage.getItem('kl_session');
      // Masquer le lien Admin si aucun utilisateur n'est connecté
      if (!isLogged) {
        const adminBtn = document.getElementById('adminBtn');
        if (adminBtn) adminBtn.style.display = 'none';
      }

      const qs = new URLSearchParams(location.search);
      const slug = qs.get('slug');
      // Fonctions de récupération des données avec fallback sur localStorage
      const allSeries = store.allSeries || (() => JSON.parse(localStorage.getItem('kl_series') || '[]'));
      const allChapters = store.allChapters || (() => JSON.parse(localStorage.getItem('kl_chapters') || '[]'));
      const pageURL = store.pageURL || (async () => null);

      const s = allSeries().find(x => x.slug === slug);
      const view = document.getElementById('view');

      if (!s) {
        view.innerHTML = '<div class="item muted">Série introuvable.</div>';
        return;
      }

      const cs = allChapters()
        .filter(c => c.seriesId === s.id)
        .sort((a,b) => ((+a.number||0) - (+b.number||0)));

      // Construire la vue de la série
      view.innerHTML = `
        <div class="top">
          <div class="cover">${s.cover ? `<img src="${s.cover}" alt="${s.title}">` : '<div class="muted">Pas de cover</div>'}</div>
          <div style="flex:1">
            <h1 class="title">${s.title}</h1>
            <div class="chips">
              ${(s.tags||[]).map(t=>`<span class="chip">${t}</span>`).join('')}
            </div>
            <div class="muted">${s.description||'—'}</div>
          </div>
        </div>

        <h3 style="margin:16px 0 8px 0">Chapitres</h3>
        <div class="grid" id="chapList">
          ${cs.length===0 ? '<div class="item muted">Aucun chapitre.</div>' : ''}
        </div>
      `;

      const listEl = document.getElementById('chapList');
      // Charger de manière asynchrone la première page de chaque chapitre pour l'aperçu
      for (const c of cs) {
        const div = document.createElement('a');
        div.href = `/reader.html?id=${c.id}`;
        div.className = 'item';
        // Placeholder du thumbnail ; sera remplacé quand l'image sera chargée
        let thumbHTML = '';
        if (c.pagesRef && c.pagesRef.length && pageURL) {
          const ref = c.pagesRef[0];
          try {
            const url = await pageURL(ref);
            if (url) {
              thumbHTML = `<img src="${url}" style="width:100%; height:100%; object-fit:cover">`;
            }
          } catch {
            // ignore
          }
        }
        if (!thumbHTML && c.pages && c.pages.length) {
          const url = c.pages[0];
          thumbHTML = `<img src="${url}" style="width:100%; height:100%; object-fit:cover">`;
        }
        div.innerHTML = `
          <div style="width:46px;height:46px; border:1px solid var(--border); border-radius:8px; overflow:hidden; background:#0e0f10;">
            ${thumbHTML}
          </div>
          <div style="font-weight:700">Chapitre ${c.number}${c.name ? ' — ' + c.name : ''}</div>
          <div class="muted" style="margin-left:auto">${c.lang||'—'} • ${c.date||'—'}</div>
        `;
        listEl.appendChild(div);
      }
    })();
  </script>
</body>
</html>
