<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Admin — Éditer un profil</title>
  <link rel="stylesheet" href="/styles/base.css"/>
  <style>
    .wrap{max-width:1100px;margin:22px auto;padding:0 16px}
    .in{height:38px;border:1px solid var(--border);border-radius:10px;background:#101112;color:#eaecef;padding:0 12px;width:100%;}
    .row{display:flex;gap:10px}
    textarea.in{height:100px;resize:vertical}
    .preview{width:120px;height:120px;border:1px solid var(--border);border-radius:10px;background:#0f1012;display:grid;place-items:center;overflow:hidden;margin-top:6px}
    .preview img{width:100%;height:100%;object-fit:cover}
  </style>
</head>
<body>
  <div class="header">
    <div class="bar">
      <div class="brand">K</div>
      <div class="badge">Admin</div>
      <div class="right"><a class="btn" href="/admin.html">Panneau</a></div>
    </div>
  </div>
  <div class="wrap">
    <div class="card">
      <h2 style="margin:0 0 12px 0">Éditer un profil</h2>
      <div class="label">Sélectionner un membre</div>
      <select id="memberSelect" class="in"></select>
      <div id="editForm" style="display:none;margin-top:12px">
        <div class="label">Nom</div>
        <input id="name" class="in" />
        <div class="label" style="margin-top:6px">Rôle</div>
        <input id="role" class="in" />
        <div class="label" style="margin-top:6px">Bio</div>
        <textarea id="bio" class="in"></textarea>
        <div class="label" style="margin-top:6px">Contact</div>
        <input id="contact" class="in" />
        <div class="label" style="margin-top:6px">Photo</div>
        <div class="preview" id="photoPrev">—</div>
        <input id="photo" class="in" type="file" accept="image/*" />
        <div class="row" style="margin-top:12px">
          <button id="saveBtn" class="btn acc">Enregistrer</button>
          <button id="delBtn" class="btn danger">Supprimer</button>
          <a class="btn" href="/admin.html">Annuler</a>
        </div>
        <div id="msg" class="label" style="margin-top:8px"></div>
      </div>
    </div>
  </div>
  <footer>© 2025 — Kyy’s Letters</footer>
  <script src="/js/storage.js"></script>
  <script>
    // Redirection si non connecté
    if (!KyyStore.isLogged()) {
      location.href = '/';
    }
    const { allMembers, saveMembers, deleteMember, uid } = KyyStore;
    const select = document.getElementById('memberSelect');
    const form = document.getElementById('editForm');
    const prev = document.getElementById('photoPrev');
    let currentId = null;
    function loadMembers() {
      const members = allMembers();
      select.innerHTML = '<option value="">— Sélectionner —</option>';
      members.forEach(m => {
        const o = document.createElement('option');
        o.value = m.id;
        o.textContent = m.name;
        select.appendChild(o);
      });
    }
    function showMember(id) {
      const members = allMembers();
      const m = members.find(x => x.id === id);
      if (!m) { form.style.display='none'; return; }
      currentId = id;
      form.style.display = 'block';
      document.getElementById('name').value = m.name;
      document.getElementById('role').value = m.role;
      document.getElementById('bio').value = m.bio || '';
      document.getElementById('contact').value = m.contact || '';
      prev.innerHTML = m.photo ? `<img src="${m.photo}" alt="">` : '—';
    }
    select.onchange = () => {
      showMember(select.value);
    };
    document.getElementById('photo').onchange = (e) => {
      const file = e.target.files[0];
      if (!file) return;
      const reader = new FileReader();
      reader.onload = () => { prev.innerHTML = `<img src="${String(reader.result||'')}" alt="">`; };
      reader.readAsDataURL(file);
    };
    document.getElementById('saveBtn').onclick = async () => {
      if (!currentId) return;
      const members = allMembers();
      const idx = members.findIndex(m => m.id === currentId);
      if (idx < 0) return;
      const file = document.getElementById('photo').files[0];
      let photoData = members[idx].photo;
      if (file) {
        const reader = new FileReader();
        photoData = await new Promise(resolve => {
          reader.onload = () => resolve(String(reader.result||''));
          reader.readAsDataURL(file);
        });
      }
      members[idx] = {
        ...members[idx],
        name: document.getElementById('name').value.trim(),
        role: document.getElementById('role').value.trim(),
        bio: document.getElementById('bio').value.trim(),
        contact: document.getElementById('contact').value.trim(),
        photo: photoData
      };
      saveMembers(members);
      document.getElementById('msg').textContent = 'Profil mis à jour ✅';
      loadMembers();
    };
    document.getElementById('delBtn').onclick = () => {
      if (!currentId) return;
      if (confirm('Supprimer ce profil ?')) {
        deleteMember(currentId);
        currentId = null;
        loadMembers();
        form.style.display = 'none';
      }
    };
    // initial
    loadMembers();
  </script>
</body>
</html>
