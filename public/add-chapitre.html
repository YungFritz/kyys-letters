<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Ajouter un chapitre — Admin</title>
  <link rel="stylesheet" href="/styles/base.css" />
</head>
<body>
  <div class="header">
    <div class="bar">
      <div class="brand">K</div>
      <div class="badge">Admin</div>
      <div class="right">
        <a class="btn" href="/admin.html">Panneau</a>
      </div>
    </div>
  </div>

  <main class="container">
    <div class="card">
      <h2 style="margin:0 0 10px">Ajouter un chapitre</h2>
      <form id="chapForm" class="grid" style="grid-template-columns:1fr 1fr; gap:12px">
        <div>
          <label class="label">Série</label>
          <select id="series" class="in"></select>
        </div>
        <div>
          <label class="label">Langue</label>
          <input id="lang" class="in" value="FR" />
        </div>

        <div>
          <label class="label">Numéro</label>
          <input id="number" class="in" type="number" value="1" />
        </div>
        <div>
          <label class="label">Nom du chapitre</label>
          <input id="name" class="in" placeholder="Nom" />
        </div>

        <div style="grid-column: 1 / -1;">
          <label class="label">Pages (images)</label>
          <input id="pages" class="in" type="file" multiple accept="image/*" />
        </div>

        <div style="grid-column: 1 / -1; display:flex; gap:10px; margin-top:10px">
          <button class="btn acc" type="submit">Enregistrer</button>
          <a class="btn" href="/admin.html">Annuler</a>
        </div>
      </form>
    </div>
  </main>

  <footer>© 2025 — Admin Kyy’s Letters</footer>

  <script src="/js/db.js"></script>
  <script src="/js/storage.js"></script>
  <script>
    const { uid, allSeries, allChapters, saveChapters, storePages } = KyyStore;

    // remplir le select série
    (function fillSeries() {
      const select = document.getElementById('series');
      const list = allSeries();
      if (!list.length) {
        alert("Aucune série. Ajoute d’abord une série.");
        location.href = '/add-manga.html';
        return;
      }
      select.innerHTML = list.map(s => `<option value="${s.id}">${s.title}</option>`).join('');
    })();

    const form = document.getElementById('chapForm');
    const pagesInput = document.getElementById('pages');

    form.onsubmit = async (e) => {
      e.preventDefault();
      const seriesId = document.getElementById('series').value;
      const number   = Number(document.getElementById('number').value);
      const name     = document.getElementById('name').value.trim();
      const lang     = document.getElementById('lang').value.trim();

      const files = pagesInput.files ? Array.from(pagesInput.files) : [];
      const pagesRef = await storePages(files);

      const c = allChapters();
      c.push({
        id: uid('chap'),
        seriesId,
        number,
        name,
        lang,
        pagesRef,
        date: new Date().toISOString(),
      });
      saveChapters(c);

      location.href = '/admin.html';
    };
  </script>
</body>
</html>
