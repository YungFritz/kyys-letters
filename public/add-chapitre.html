<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Ajouter un chapitre</title>
  <link rel="stylesheet" href="/styles/base.css"/>
</head>
<body>
  <div class="header">
    <div class="bar">
      <div class="brand">K</div>
      <div class="badge">Ajouter Chapitre</div>
      <div class="right"><a class="btn" href="/admin.html">Admin</a></div>
    </div>
  </div>

  <div class="container grid" style="grid-template-columns:1fr 1fr;">
    <form class="card" id="form">
      <h2 style="margin:0 0 12px 0">Nouveau chapitre</h2>

      <div class="label">Série *</div>
      <select id="serie" class="input" required></select>

      <div class="row">
        <div>
          <div class="label">Numéro *</div>
          <input class="input" id="number" type="number" required min="0" step="0.1" placeholder="1"/>
        </div>
        <div>
          <div class="label">Langue</div>
          <input class="input" id="lang" placeholder="FR"/>
        </div>
      </div>

      <div class="label">Titre</div>
      <input class="input" id="title" placeholder="Titre du chapitre"/>

      <div class="label" style="margin-top:10px;">Date</div>
      <input class="input" id="date" type="date"/>

      <div class="label" style="margin-top:10px;">Pages (images, multiple)</div>
      <input id="pages" type="file" accept="image/*" multiple/>

      <div style="display:flex;gap:8px;margin-top:14px">
        <button class="btn acc" type="submit">Enregistrer</button>
        <a class="btn" href="/admin.html">Annuler</a>
      </div>
    </form>

    <div class="card">
      <h3 style="margin:0 0 8px 0">Aperçu pages</h3>
      <div id="preview" class="grid" style="grid-template-columns:repeat(auto-fill,minmax(120px,1fr));gap:10px"></div>
    </div>
  </div>

  <footer>© 2025 — Kyy’s Letters</footer>

  <script src="/js/storage.js"></script>
  <script>
    const { allSeries, saveSeries, allChapters, saveChapters, uid } = KyyStore;
    const select = document.getElementById("serie");
    const series = allSeries();
    if(!series.length){ alert("Ajoute d’abord une série."); location.href="/add-manga.html"; }

    series.forEach(s=>{
      const o = document.createElement("option");
      o.value = s.id; o.textContent = s.title; select.appendChild(o);
    });

    let pagesData = [];
    document.getElementById("pages").addEventListener("change", async (e)=>{
      const files = Array.from(e.target.files||[]);
      pagesData = [];
      const preview = document.getElementById("preview");
      preview.innerHTML = "";
      for (const f of files) {
        const url = await fileToDataURL(f);
        pagesData.push(url);
        const img = document.createElement("img");
        img.src = url; img.style.width="100%"; img.style.borderRadius="10px";
        preview.appendChild(img);
      }
    });

    function fileToDataURL(file){
      return new Promise((res,rej)=>{
        const r = new FileReader();
        r.onload = ()=>res(String(r.result||""));
        r.onerror = rej;
        r.readAsDataURL(file);
      });
    }

    document.getElementById("form").addEventListener("submit",(e)=>{
      e.preventDefault();
      const seriesId = select.value;
      const number = parseFloat(document.getElementById("number").value);
      const title = document.getElementById("title").value.trim();
      const lang = document.getElementById("lang").value.trim() || "FR";
      const date = document.getElementById("date").value || new Date().toISOString().slice(0,10);

      if(!pagesData.length){ if(!confirm("Aucune page importée. Continuer ?")) return; }

      const chap = { id: uid("chap"), seriesId, title, number, lang, date, pages: pagesData };
      const ch = allChapters(); ch.push(chap); saveChapters(ch);

      // compter dans la série
      const s = series.find(x=>x.id===seriesId);
      if(s){ s.chapters = (s.chapters||[]); s.chapters.push(chap.id); saveSeries(series); }

      alert("Chapitre ajouté !");
      location.href="/admin.html";
    });
  </script>
</body>
</html>
