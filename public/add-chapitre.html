<!doctype html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Admin — Ajouter Chapitre</title>
  <link rel="stylesheet" href="/src/index.css" />
  <style>
    .wrap{max-width:900px;margin:30px auto;padding:0 16px}
    .f{display:grid;gap:10px}
    .in{height:38px;border:1px solid var(--border);border-radius:10px;background:#101112;color:#eaecef;padding:0 12px}
    .row{display:flex;gap:10px;flex-wrap:wrap}
    .btn{display:inline-grid;place-items:center;height:40px;padding:0 14px;border-radius:10px;border:1px solid #275f41;background:#23724a;color:#fff}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="card-like">
      <h2>Ajouter un chapitre</h2>
      <div class="f">
        <select id="manga" class="in"></select>
        <input id="num" class="in" type="number" placeholder="Numéro (ex: 1)" />
        <input id="name" class="in" placeholder="Nom du chapitre" />
        <input id="lang" class="in" placeholder="Langue (FR, EN…)" />
        <div class="row">
          <input id="pages" type="file" accept="image/*" multiple class="in" />
          <button class="btn" id="save">Enregistrer</button>
        </div>
        <a class="nav-btn" href="/admin.html">← Admin</a>
      </div>
    </div>
  </div>

<script>
const MKEY='kl_mangas';
function load(){try{return JSON.parse(localStorage.getItem(MKEY)||'[]')}catch{return[]}}
function save(a){localStorage.setItem(MKEY,JSON.stringify(a))}
function toBase64(file){return new Promise((res,rej)=>{const r=new FileReader();r.onload=()=>res(r.result);r.onerror=rej;r.readAsDataURL(file)})}

const select=document.getElementById('manga');
const list=load();
select.innerHTML = list.map(m=>`<option value="${m.slug}">${m.title}</option>`).join('') || `<option>(Aucun manga)</option>`;

document.getElementById('save').onclick = async ()=>{
  const slug=select.value;
  const num=Number(document.getElementById('num').value);
  const name=document.getElementById('name').value.trim();
  const lang=document.getElementById('lang').value.trim()||'FR';
  const files=[...document.getElementById('pages').files];

  if(!slug) return alert('Choisir un manga');
  if(!num) return alert('Numéro invalide');
  if(!files.length) return alert('Ajouter au moins 1 page');

  const pages=[];
  for(const f of files){ pages.push(await toBase64(f)); }

  const m=list.find(x=>x.slug===slug);
  m.chapters = m.chapters||[];
  m.chapters.push({
    id:crypto.randomUUID(),
    name,number:num,lang,releaseDate:new Date().toISOString().slice(0,10),pages
  });
  // trier par numéro
  m.chapters.sort((a,b)=>a.number-b.number);

  save(list);
  alert('Chapitre ajouté ! URL : /chapitre-'+num+'/'+slug);
  location.href='/admin.html';
};
</script>
</body>
</html>
