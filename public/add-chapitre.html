<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8">
  <title>Ajouter un chapitre • Kyy’s Letters</title>
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <link href="/page.css" rel="stylesheet">
</head>
<body>
  <div class="wrap">
    <!-- Barre du haut -->
    <div class="topbar">
      <a class="pill k" href="/">K</a>
      <a class="pill" href="/personnelle.html">Personnelle</a>
      <a class="pill" href="/recrutement.html">Recrutement</a>
      <a class="pill" href="/admin.html">Admin</a>
      <a class="pill" href="/">Accueil</a>
    </div>

    <!-- Carte formulaire -->
    <div class="card pad">
      <h1>Ajouter un chapitre</h1>

      <div class="row" style="margin-top:12px">
        <select id="manga" class="select">
          <option value="">(Aucun manga)</option>
        </select>

        <input id="number" class="input" placeholder="Numéro (ex: 1)">
        <input id="name" class="input" placeholder="Nom du chapitre">
        <input id="lang" class="input" placeholder="Langue (FR, EN...)">

        <div style="display:flex;align-items:center;gap:10px;flex-wrap:wrap">
          <input id="pages" class="file" type="file" accept="image/*" multiple>
          <button id="save" class="btn">Enregistrer</button>
          <a class="btn ghost" href="/admin.html">← Admin</a>
        </div>
      </div>

      <p id="status" style="margin-top:10px;color:var(--muted)"></p>
    </div>
  </div>

<script>
const get = (k, d) => { try{ return JSON.parse(localStorage.getItem(k)) ?? d }catch{ return d } }
const set = (k, v) => localStorage.setItem(k, JSON.stringify(v));

/* ====== populate mangas ====== */
const mangas = get('mangas', []);
const select = document.getElementById('manga');
mangas.forEach(m=>{
  const opt = document.createElement('option');
  opt.value = m.slug; opt.textContent = m.title;
  select.appendChild(opt);
});

/* ====== Save chapter ====== */
document.getElementById('save').addEventListener('click', async () => {
  const slug = select.value;
  const number = parseInt(document.getElementById('number').value,10);
  const name   = document.getElementById('name').value.trim();
  const lang   = document.getElementById('lang').value.trim();
  const files  = [...document.getElementById('pages').files];

  if(!slug){ return msg("Choisis un manga."); }
  if(!number || number<1){ return msg("Numéro de chapitre invalide."); }
  if(!files.length){ return msg("Ajoute au moins 1 page."); }

  const m = mangas.find(x=>x.slug===slug);
  const pages = await Promise.all(files.map(toBase64));

  const chap = {
    id: crypto.randomUUID(),
    name, number, lang,
    releaseDate: new Date().toISOString().slice(0,10),
    pages
  };

  m.chapters = m.chapters || [];
  m.chapters.push(chap);
  // trie par numéro
  m.chapters.sort((a,b)=> a.number - b.number);

  set('mangas', mangas);
  msg("Chapitre enregistré ✅");
  // location.href = "/admin.html";
});

function msg(t){ document.getElementById('status').textContent = t; }
function toBase64(file){
  return new Promise((res,rej)=>{
    const fr = new FileReader();
    fr.onload=()=>res(fr.result); fr.onerror=rej; fr.readAsDataURL(file);
  });
}
</script>
</body>
</html>
