<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Admin — Ajouter un chapitre</title>
  <link rel="stylesheet" href="/styles/base.css"/>
  <style>
    .wrap{max-width:980px;margin:22px auto;padding:0 16px}
    .f{display:grid;gap:10px}
    .in{height:38px;border:1px solid var(--border);border-radius:10px;background:#101112;color:#eaecef;padding:0 12px}
    .row{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
    .grid2{display:grid;grid-template-columns:1fr 1fr;gap:10px}
    .thumbs{display:grid;grid-template-columns:repeat(auto-fill,minmax(90px,1fr));gap:8px}
    .thumbs img{width:100%;height:90px;object-fit:cover;border:1px solid var(--border);border-radius:8px;background:#0f1012}
  </style>
</head>
<body>
  <div class="header">
    <div class="bar">
      <div class="brand">K</div>
      <div class="badge">Admin</div>
      <div class="right">
        <a class="btn" href="/">Accueil</a>
        <a class="btn" href="/admin.html">Panneau</a>
      </div>
    </div>
  </div>

  <div class="wrap">
    <div class="card">
      <h2 style="margin:0 0 10px 0">Ajouter un chapitre</h2>

      <form id="form" class="f">
        <select id="series" class="in" required></select>

        <div class="grid2">
          <input id="number" class="in" placeholder="Numéro (ex: 1)" required />
          <input id="lang" class="in" placeholder="Langue (FR, EN…)" />
        </div>

        <input id="name" class="in" placeholder="Nom du chapitre" />

        <div class="row">
          <input id="pages" class="in" type="file" multiple accept="image/*" style="flex:1"/>
          <button class="btn acc" type="submit">Enregistrer</button>
          <a class="btn" href="/admin.html">Annuler</a>
        </div>

        <div id="thumbs" class="thumbs"></div>
      </form>

      <div id="msg" class="label" style="margin-top:8px"></div>
    </div>
  </div>

  <footer>© 2025 — Admin Kyy’s Letters</footer>

  <script src="/js/storage.js"></script>
  <script>
    const { allSeries, saveSeries } = KyyStore;

    const select = document.getElementById('series');
    const thumbs = document.getElementById('thumbs');
    const list = allSeries();
    if(!list.length){ alert("Aucune série. Ajoute d’abord."); location.href="/add-manga.html"; }

    // peupler le select
    list.forEach(s=>{
      const o=document.createElement('option');
      o.value=s.id; o.textContent=s.title;
      select.appendChild(o);
    });

    // preview pages
    document.getElementById('pages').addEventListener('change', async (e)=>{
      const files=[...(e.target.files||[])];
      thumbs.innerHTML='';
      for(const f of files){
        const b64 = await toBase64(f);
        const img = new Image();
        img.src = b64;
        thumbs.appendChild(img);
      }
    });

    document.getElementById('form').addEventListener('submit', async (e)=>{
      e.preventDefault();
      const seriesId = select.value;
      const number = parseInt(document.getElementById('number').value,10);
      const name = document.getElementById('name').value.trim();
      const lang = document.getElementById('lang').value.trim();
      const files = [...document.getElementById('pages').files];

      if(!seriesId) return msg('Choisis une série.');
      if(!number || number < 1) return msg('Numéro de chapitre invalide.');
      if(!files.length) return msg('Ajoute au moins 1 page.');

      const s = list.find(x=>x.id===seriesId);
      const pages = await Promise.all(files.map(toBase64));

      const chap = {
        id: crypto.randomUUID(),
        name, number, lang,
        releaseDate: new Date().toISOString().slice(0,10),
        pages
      };

      s.chapters = s.chapters || [];
      s.chapters.push(chap);
      s.chapters.sort((a,b)=> a.number - b.number);

      saveSeries(list);
      msg('Chapitre enregistré ✅');
      // location.href='/admin.html';
    });

    function msg(t){ document.getElementById('msg').textContent=t; }
    function toBase64(file){
      return new Promise((res,rej)=>{
        const r=new FileReader();
        r.onload=()=>res(String(r.result)); r.onerror=rej; r.readAsDataURL(file);
      });
    }
  </script>
</body>
</html>
