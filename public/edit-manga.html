<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Éditer une série</title>
  <link rel="stylesheet" href="/styles/base.css"/>
</head>
<body>
  <div class="header">
    <div class="bar">
      <div class="brand">K</div>
      <div class="badge">Éditer Série</div>
      <div class="right"><a class="btn" href="/admin.html">Admin</a></div>
    </div>
  </div>

  <div class="container grid" style="grid-template-columns:1fr 1fr;">
    <div class="card">
      <div class="label">Choisir une série</div>
      <select id="pick" class="input"></select>
    </div>

    <form class="card" id="form" style="display:none">
      <h2 style="margin:0 0 12px 0" id="formTitle">Modifier</h2>

      <div class="label">Titre</div>
      <input class="input" id="title"/>

      <div class="row">
        <div>
          <div class="label">Tags</div>
          <input class="input" id="tags"/>
        </div>
        <div>
          <div class="label">Statut</div>
          <select id="status" class="input">
            <option value="en-cours">En cours</option>
            <option value="termine">Terminé</option>
            <option value="drop">Drop</option>
          </select>
        </div>
      </div>

      <div class="label">Description</div>
      <textarea class="input" id="desc" rows="5"></textarea>

      <div class="label" style="margin-top:10px;">Changer cover</div>
      <input id="cover" type="file" accept="image/*"/>

      <div style="display:flex;gap:8px;margin-top:14px">
        <button class="btn acc" type="submit">Sauvegarder</button>
        <button class="btn danger" id="del" type="button">Supprimer</button>
      </div>
    </form>

    <div class="card" id="previewCard" style="display:none">
      <h3 style="margin:0 0 8px 0">Aperçu cover</h3>
      <div id="preview" class="label">—</div>
    </div>
  </div>

  <footer>© 2025 — Kyy’s Letters</footer>

  <script src="/js/storage.js"></script>
  <script>
    const { allSeries, saveSeries, allChapters, saveChapters, slugify } = KyyStore;
    const pick = document.getElementById("pick");
    const form = document.getElementById("form");
    const previewCard = document.getElementById("previewCard");
    const series = allSeries();
    if(!series.length){ alert("Aucune série. Ajoute d’abord."); location.href="/add-manga.html"; }

    series.forEach(s=>{
      const o=document.createElement("option");o.value=s.id;o.textContent=s.title;pick.appendChild(o);
    });
    let current=null, coverData="";

    function load(id){
      current = series.find(x=>x.id===id);
      if(!current){ form.style.display="none"; previewCard.style.display="none"; return; }
      form.style.display="block"; previewCard.style.display="block";
      document.getElementById("formTitle").textContent = `Modifier — ${current.title}`;
      document.getElementById("title").value = current.title||"";
      document.getElementById("tags").value = (current.tags||[]).join(", ");
      document.getElementById("status").value = current.status||"en-cours";
      document.getElementById("desc").value = current.description||"";
      coverData = current.cover||"";
      document.getElementById("preview").innerHTML = coverData? `<img src="${coverData}" style="max-width:100%;border-radius:12px"/>` : "—";
    }
    load(pick.value = series[0].id);
    pick.onchange = ()=>load(pick.value);

    document.getElementById("cover").onchange = e=>{
      const f = e.target.files?.[0]; if(!f) return;
      const r = new FileReader();
      r.onload = ()=>{ coverData = String(r.result||""); document.getElementById("preview").innerHTML = `<img src="${coverData}" style="max-width:100%;border-radius:12px"/>`;};
      r.readAsDataURL(f);
    };

    form.onsubmit = (e)=>{
      e.preventDefault();
      current.title = document.getElementById("title").value.trim() || current.title;
      current.slug = slugify(current.title);
      current.tags = document.getElementById("tags").value.split(",").map(s=>s.trim()).filter(Boolean);
      current.status = document.getElementById("status").value;
      current.description = document.getElementById("desc").value.trim();
      if(coverData) current.cover = coverData;
      saveSeries(series);
      alert("Série mise à jour !");
      load(current.id);
    };

    document.getElementById("del").onclick = ()=>{
      if(!confirm("Supprimer la série et ses chapitres ?")) return;
      // suppr chapitres liés
      const ch = allChapters().filter(c=>c.seriesId!==current.id);
      saveChapters(ch);
      // suppr série
      const idx = series.findIndex(x=>x.id===current.id);
      if(idx>=0){ series.splice(idx,1); saveSeries(series); }
      alert("Supprimé.");
      location.href="/admin.html";
    };
  </script>
</body>
</html>
